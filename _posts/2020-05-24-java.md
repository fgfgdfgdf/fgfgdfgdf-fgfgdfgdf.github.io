---
title: java
date: 2020-05-28
layout: post
---

_______________________________________________________________

##### 获取pid

```java
    String jvmName=ManagementFactory.getRuntimeMXBean().getName();
    String pid=jvmName.split("@")[0];

```

_______________________________________________________________

##### 热更新

attach方式

1. 编写agent.jar,固定的方法名和参数

```java
public class AgentMain {

    private static final Logger log = LoggerFactory.getLogger(AgentMain.class);

    public static void agentmain(String args, Instrumentation instrumentation) {
        // args为调用loadAgent时传递的参数
        log.warn("agentmain start,args:{}", args);
    
        try {
            // 热更新两步
            // 1.构造ClassDefinition(类名+class文件字节数据)
            // 2.调用instrumentation.redefineClasses(classDefinition)进行热更新
            FileInputStream fileInputStream = new FileInputStream("F://file.class");
            byte[] bytes = new byte[fileInputStream.available()];
            fileInputStream.read(bytes);
            ClassDefinition classDefinition = new ClassDefinition(Class.forName("com.sample.sample1.Dog"), bytes);
            instrumentation.redefineClasses(classDefinition);

        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}
```  

2. agent.jar maven打包参数

```xml

<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-jar-plugin</artifactId>
    <configuration>
        <archive>
            <manifest>
                <addClasspath>true</addClasspath>
                <classpathPrefix>lib/</classpathPrefix>
            </manifest>
            <!--必须有-->
            <manifestEntries>
                <Agent-Class>com.sample.agent.AgentMain</Agent-Class>
                <Can-Redefine-Classes>true</Can-Redefine-Classes>
                <Can-Retransform-Classes>true</Can-Retransform-Classes>
            </manifestEntries>
        </archive>
    </configuration>
</plugin>
```  

3. 应用程序调用(依赖tools.jar)

```java
        List<VirtualMachineDescriptor> list=VirtualMachine.list();
        for(VirtualMachineDescriptor vm:list){
            if(vm.id().equals(pid)){
                // 1.调用attach(pid),pid为需要热更新的进程
                VirtualMachine virtualMachine=vm.provider().attachVirtualMachine(pid);
                // 2.调用loadAgent(),参数1为agent.jar包路径,参数2为传递的参数(agentmain方法中的args)
                virtualMachine.loadAgent("C:\\code\\basics\\sample1\\target\\lib\\agent-1.0.jar","hello world");
                // 3.关闭
                virtualMachine.detach();
            }
        }

```  

tools.jar的maven依赖  

```xml

<dependency>
    <groupId>jdk</groupId>
    <artifactId>tools</artifactId>
    <version>${java.version}</version>
    <scope>system</scope>
    <systemPath>${JAVA_HOME}/lib/tools.jar</systemPath>
</dependency>

```
_______________________________________________________________

##### 类加载